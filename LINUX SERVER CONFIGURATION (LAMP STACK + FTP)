#!/bin/bash
# ============================================================
# LINUX SERVER CONFIGURATION (LAMP STACK + FTP SERVER)
# ============================================================

# STEP 1: Update System
sudo apt update && sudo apt upgrade -y

# STEP 2: Install Apache Web Server
sudo apt install apache2 -y
sudo systemctl enable apache2
sudo systemctl start apache2

# STEP 3: Install MySQL Server
sudo apt install mysql-server -y
sudo systemctl enable mysql
sudo systemctl start mysql
sudo mysql_secure_installation

# STEP 4: Install PHP and Dependencies
sudo apt install php libapache2-mod-php php-mysql -y

# STEP 5: Test PHP
echo "<?php phpinfo(); ?>" | sudo tee /var/www/html/info.php > /dev/null

# STEP 6: Configure Firewall (UFW)
sudo ufw allow OpenSSH
sudo ufw allow 'Apache Full'
sudo ufw enable

# STEP 7: Install FTP Server (vsftpd)
sudo apt install vsftpd -y
sudo systemctl enable vsftpd
sudo systemctl start vsftpd

# STEP 8: Configure vsftpd
sudo cp /etc/vsftpd.conf /etc/vsftpd.conf.bak
sudo bash -c 'cat > /etc/vsftpd.conf <<EOF
listen=YES
anonymous_enable=NO
local_enable=YES
write_enable=YES
chroot_local_user=YES
allow_writeable_chroot=YES
local_umask=022
user_sub_token=\$USER
local_root=/home/\$USER/ftp
pasv_min_port=40000
pasv_max_port=50000
EOF'

# STEP 9: Restart FTP Service
sudo systemctl restart vsftpd

# STEP 10: Create FTP User
sudo adduser ftpuser
sudo mkdir -p /home/ftpuser/ftp/files
sudo chown nobody:nogroup /home/ftpuser/ftp
sudo chmod a-w /home/ftpuser/ftp
sudo chown ftpuser:ftpuser /home/ftpuser/ftp/files

# STEP 11: Create Sample Website
sudo bash -c 'cat > /var/www/html/index.html <<EOF
<!DOCTYPE html>
<html>
<head>
<title>My LAMP Server</title>
</head>
<body>
<h1>Welcome to My LAMP + FTP Server!</h1>
<p>Configured by Linux Automation Script</p>
</body>
</html>
EOF'

# STEP 12: Restart Apache
sudo systemctl restart apache2

# STEP 13: Display Service Status Summary
echo "------------------------------------------------------------"
echo "SERVICE STATUS:"
sudo systemctl status apache2 | grep Active
sudo systemctl status mysql | grep Active
sudo systemctl status vsftpd | grep Active
echo "------------------------------------------------------------"
echo "LAMP + FTP SERVER CONFIGURATION COMPLETE!"
echo "Access Web Server: http://<your_server_ip>"
echo "Access FTP Server: ftp://<your_server_ip>"
echo "------------------------------------------------------------"
